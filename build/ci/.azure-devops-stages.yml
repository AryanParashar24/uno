resources:
  containers:
  - container: nv-bionic-wasm
    image: unoplatform/wasm-build:3.0

variables:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  windows2019HostedVMImage: 'windows-2019'
  windows2022HostedVMImage: 'windows-2022'
  windowsScaledPool: 'Windows2022-20220925-1'
  linuxVMImage: 'ubuntu-latest'
  macOSVMImage: 'macOS-12'
  macOSVMImage_UITests: 'macOS-12'
  xCodeRoot: '/Applications/Xcode_14.1.app'
  XamarinSDKVersion: 6_12_24
  xCodeRoot_iOS_UITests: '/Applications/Xcode_14.1.app'
  XamarinSDKVersion_iOS_UITests: 6_12_24

  # https://github.com/microsoft/azure-pipelines-tasks/issues/11864
  #enable_package_cache: true

stages:
- stage: Setup
  displayName: Setup
  jobs:
  - template: build/ci/.azure-devops-commitsar.yml
    parameters:
      vmImage: '$(linuxVMImage)'

  - template: build/ci/.azure-devops-spell-check.yml
    parameters:
      vmImage: '$(linuxVMImage)'

  - template: build/ci/.azure-devops-pipeline-validations.yml
    parameters:
      vmImage: '$(linuxVMImage)'

- stage: convert_tree
  displayName: WinUI Tree Conversion
  dependsOn:
    - Setup
  jobs:
  - template: build/ci/.azure-devops-winui-convert.yml
    parameters:
      poolName: '$(windowsScaledPool)'

- stage: Packages_Build
  displayName: Build Packages
  dependsOn:
    - Setup
    - convert_tree

  jobs: 
  - template: build/ci/.azure-devops-package-net6-win.yml
    parameters:
      poolName: '$(windowsScaledPool)'
  
  - template: build/ci/.azure-devops-package-wasm.yml
    parameters:
      vmImage: '$(linuxVMImage)'
  
  - template: build/ci/.azure-devops-package-reference.yml
    parameters:
      vmImage: '$(linuxVMImage)'
      
  - template: build/ci/.azure-devops-package-skia.yml
    parameters:
      vmImage: '$(linuxVMImage)'
  
  - template: build/ci/.azure-devops-package.yml
    parameters:
      poolName: '$(windowsScaledPool)'

  - template: build/ci/.azure-devops-project-template-tests.yml
    parameters:
      poolName: '$(windowsScaledPool)'
      vmImageWindows: $(windows2022HostedVMImage)
      vmImageLinux: '$(linuxVMImage)'

- stage: Tests_1
  displayName: Tests 1
  dependsOn:
    - Packages_Build
    - convert_tree

  jobs:
  - template: build/ci/.azure-devops-unit-tests.yml
    parameters:
      vmImage: '$(windows2022HostedVMImage)'
  
  - template: build/ci/.azure-devops-wasm-uitests.yml
    parameters:
      vmImage: '$(linuxVMImage)'

- stage: Tests_2
  displayName: Tests 2
  dependsOn:
    - Setup

  jobs:
  - template: build/ci/.azure-devops-skia-tests.yml
    parameters:
      vmImage: '$(windows2022HostedVMImage)'
      vmMacImage: '$(macOSVMImage)'
      poolName: '$(windows2022HostedVMImage)'
  
  - template: build/ci/.azure-devops-macos.yml
    parameters:
      vmImage: '$(macOSVMImage)'
      xCodeRoot: '$(xCodeRoot)'
      XamarinSDKVersion: '$(XamarinSDKVersion)'
  
  - template: build/ci/.azure-devops-android-tests.yml
    parameters:
      vmWindowsImage: '$(windows2019HostedVMImage)'
      vmMacOSImage: '$(macOSVMImage)'
      xCodeRoot: '$(xCodeRoot)'
      XamarinSDKVersion: '$(XamarinSDKVersion)'
  
  - template: build/ci/.azure-devops-ios-tests.yml
    parameters:
      vmImage: '$(macOSVMImage)'
      vmImageTest: '$(macOSVMImage_UITests)'
      xCodeRootBuild: '$(xCodeRoot)'
      XamarinSDKVersionBuild: '$(XamarinSDKVersion)'
      xCodeRootTest: '$(xCodeRoot_iOS_UITests)'
      XamarinSDKVersionTest: '$(XamarinSDKVersion_iOS_UITests)'

  - template: build/ci/.azure-devops-uap.yml
    parameters:
      vmImage: '$(windows2022HostedVMImage)'

- stage: test_finalization
  displayName: Test Finalization
  dependsOn:
    - Tests_1
    - Tests_2
- 
  jobs:
  - template: build/ci/.azure-devops-screenshot-compare.yml
    parameters:
      poolName: '$(windowsScaledPool)'
